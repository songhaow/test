<!DOCTYPE html>
<meta charset="utf-8">

<html>

<body>
  <svg width="560" height="300" style="border: 1px solid black;">
  </svg>
  <div id="displayButton">
    hit me
  </div>
  <audio id="track1" src="source_audio/eyes.m4a" type="audio/mpeg" crossorigin="anonymous"></audio>
</body>

<script src="https://d3js.org/d3.v4.min.js"></script>

<script>

var isPlaying = false;

// Load the audio context library and build an audio context object that will
// manage how music is played
// Tutorial: https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API/Using_Web_Audio_API
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();
// get the audio element
const audioElement = document.querySelector('#track1');
// create a audio context track object
const track = audioCtx.createMediaElementSource(audioElement);
// connect track to destination
track.connect(audioCtx.destination);

////DRAG//////////////////////////////////////////////////////////
 function dragstarted(d) {
   d3.select(this).raise().classed("active", true);
   startX=d3.event.x;
   console.log('startX: ', startX);
   return startX
 }
 function dragged(d) {
   d.x = d3.event.x;
   d3.select(this).attr("transform", 'translate('+d.x+','+this.getCTM().f+')');
 }
 function dragended(d) {
   d3.select(this).classed("active", false);
   endX=d3.event.x;
   console.log('endX: ', endX);
   return endX
 }

 /////ZOOM/////////////////////////////////////////////////////////////////////////////
 var scalewidth;
 var zoom = d3.zoom()
                    .scaleExtent([1, 1.1])
                    .on("zoom", zoomed);

 var slider = d3.select('body')
                       .append("p")
                       .append("input")
                       .datum({})
                       .attr("type", "range")
                       .attr("value", zoom.scaleExtent()[0])
                       .attr("min", zoom.scaleExtent()[0])
                       .attr("max", zoom.scaleExtent()[1])
                       .attr("step", (zoom.scaleExtent()[1] - zoom.scaleExtent()[0])/100)
                       .on("input", slided);

function slided(d) {
                      zoom.scaleTo(svg, d3.select(this).property("value"));
                      scalewidth=d3.select(this).property("value");
                      return scalewidth;
                           }
function zoomed() {
                      const currentTransform = d3.event.transform;
                      group.attr("transform", currentTransform);
                      slider.property("value", currentTransform.k);
                          }
//////////////////////////////////////////////////////////////////////////////

 // * Main function

function mainLoad() {
  var trackInfo = getTrackInfo();

  console.log(trackInfo);

var group=d3.select('svg').selectAll('g')
    .data(trackInfo)
    .enter().append('g')
      .attr('x', 0)
      .attr('transform', function(d) {return 'translate(10,' + d.y + ')';})
    .call(d3.drag()
      .on("start", dragstarted)
      .on('drag', dragged)
      .on("end", dragended));

group.selectAll('rect')
      .data(function(d) {return d.trackData;})
      .enter().append('rect')
        .attr('fill', 'black')
        .attr('width', 2)
        .attr('height', 90)
        .attr('x', function(d, i) {return d*8;});

  d3.select('#displayButton').on("click", displayInfo);

  function displayInfo() {
    var xVal = document.getElementById("track1").getCTM();
    if (!isPlaying) {
      console.log('Play');
      audioElement.play();
      isPlaying = true;
    } else {
      console.log('Pause');
      audioElement.pause();
      isPlaying = false;
    }};

};

function getTrackInfo() {
  return [
    {
      id: 'track1',
      y: 10,
      width: 100,
      trackData: d3.range(150).map(function () { return Math.round(Math.random()*50);}),
    },
    {
      id: 'track2',
      y: 110,
      width: 100,
      trackData: d3.range(150).map(function () { return Math.round(Math.random()*50);}),
    }
  ]
};

mainLoad();

</script>

</html>
